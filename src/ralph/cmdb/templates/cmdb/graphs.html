{%extends 'cmdb/base.html'%}

{% load bob %}
{% load icons %}
{% block extra_headers %}
<style type='text/css'>
    svg
    {
        z-index: 1000; /* top-most */
    }
</style>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <script type="text/javascript" src="{{STATIC_URL}}cmdb/VivaGraphJS/vivagraph.js"></script>
    <script type="text/javascript">
        function from_canvas_to_svg(sourceCanvas, targetSVG, x, y, width, height) {
            var imageData = sourceCanvas.getContext('2d').getImageData(
                x, y, width, height);
            var newCanvas = document.createElement("canvas");
            newCanvas.width = width; newCanvas.height = height;
            newCanvas.getContext("2d").putImageData(imageData, 0, 0);
            var img_dataurl = newCanvas.toDataURL("image/png");
            targetSVG.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", img_dataurl);
    }

    function draw_graph(data, sprite_canvas) {
        var graph = Viva.Graph.graph();
        for (var i=0; i<data.nodes.length; i++)
        {
            graph.addNode(data.nodes[i][0], data.nodes[i][1]);
        }
        for (var i=0; i<data.relations.length; i++)
        {
            graph.addLink(data.relations[i].parent, data.relations[i].child);
        }
        var graphics = Viva.Graph.View.svgGraphics();
        graphics.node(function(node) {
                var image = Viva.Graph.svg('image');
                from_canvas_to_svg(sprite_canvas, image, 0, 0, 16, 16);
                image.attr('width', 16).attr('height', 16);
                var g = Viva.Graph.svg('g').attr('width', 224).attr('height', 180);
                var e = Viva.Graph.svg('text').attr('width', 224).attr('height', 180);
                e.textContent = node.data;
                g.appendChild(e);
                g.appendChild(image);
                return g;
        })
        .placeNode(function(nodeUI, pos){
                var nu = nodeUI;
                nu.childNodes[0].attr('x', pos.x).attr('y', pos.y);
                nu.childNodes[1].attr('x', pos.x).attr('y', pos.y);
        });
        var renderer = Viva.Graph.View.renderer(graph, {
             container  : document.getElementById('graphDiv'),
            graphics : graphics
        });
        renderer.run();
    }
</script>

<script type="text/javascript" charset="utf-8">
    var MAX_RELATIONS_COUNT = 100;

    $(document).ready(function()
    {
        /* 
          Don't make additional ajax call, just use graph_data directly. 
         */
        var graph_data = JSON.parse("{{graph_data|escapejs}}");
        if (graph_data.nodes.length > MAX_RELATIONS_COUNT)
        {
            alert('To many relations to draw a graph.')
        }
        else
        {
            var can = document.createElement('canvas')
            can.style.display = 'none';
            var ctx = can.getContext('2d');
            var img = new Image();
            img.onload = function(){
                can.width = img.width;
                can.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                draw_graph(graph_data, can);
            }
            var sprite_url = '/static/fugue-icons.png';
            img.src = sprite_url; 
        }
    });
</script>

{% endblock %}

{% block contentarea %}
    {{ block.super }}

    {% form_horizontal form=form method="get" action="/cmdb/graphs" title='Formularz' %}
    <hr>
    <table class="table table-striped table-condensed table-list table-bordered">
        <tbody>
        <tr>
            <th>L.p</th>
            <th>Name</th>
            <th>Type</th>
            <th>UID</th>
            <th>Venture/Role</th>
        </tr>
        {% for row in rows %}
        <tr>
            <td>
                {{ forloop.counter }}
            </td>
            <td>
            <a href="/cmdb/ci/view/{{ row.ci.id }}">
                <b><i class='fugue-icon {{ row.icon }}'></i> {{ row.ci.name }} </b> 
            </a></td>
            <td>{{ row.ci.type }} {{ row.ci.content_object.model}}</td>
            <td>{{ row.ci.uid }}</td>
            <td>{{ row.content_object.venture}} {{ row.content_object.role }}</td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
    <h4> Impact graph </h4>
    <div id='graphDiv' width=800 height=800 style='width:800px; height:800px;border: solid #ddd 1px'>
    </div>

{% endblock %}
