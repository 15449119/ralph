{%extends 'cmdb/base.html'%}

{% load bob %}
{% load icons %}
{% block extra_headers %}
<style type='text/css'>
    svg
    {
        z-index: 1000; /* top-most */
    }
</style>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <script type="text/javascript" src="{{STATIC_URL}}cmdb/VivaGraphJS/vivagraph.js"></script>
    <script type="text/javascript">
        function from_canvas_to_svg(sourceCanvas, targetSVG, x, y, width, height) {
            var imageData = sourceCanvas.getContext('2d').getImageData(
                x, y, width, height);
            var newCanvas = document.createElement("canvas");
            newCanvas.width = width; newCanvas.height = height;
            newCanvas.getContext("2d").putImageData(imageData, 0, 0);
            var img_dataurl = newCanvas.toDataURL("image/png");
            targetSVG.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", img_dataurl);
    }

    function type_to_color(type)
{
        if (type == 1) // contains
        {
                return '#ddd';
        }
        else if (type == 2)
        {
                return 'red';
        }
        else
        {
                return 'black';
        }
    }

    function draw_graph(data, sprite_canvas) {
        var graph = Viva.Graph.graph();
        var graphics = Viva.Graph.View.svgGraphics(), nodeSize = 32;
        var renderer = Viva.Graph.View.renderer(graph, {
             container  : document.getElementById('graphDiv'),
            graphics : graphics
            });
        renderer.run();
        graphics.node(function(node) {
                var sprite_name = node.data.icon.replace('fugue-', '');
                var coord = fugue_data[sprite_name];
                var image = Viva.Graph.svg('image');
                from_canvas_to_svg(sprite_canvas, image, coord[0], coord[1], 16, 16);
                image.attr('width', 16).attr('height', 16);
                var g = Viva.Graph.svg('g').attr('width', 224).attr('height', 180);
                var e = Viva.Graph.svg('text').attr('width', 124).attr('height', 80).attr('font-size', '7');
                e.textContent = node.data.name;
                g.appendChild(e);
                g.appendChild(image);
                return g;
        })
        .placeNode(function(nodeUI, pos){
                var nu = nodeUI;
                nu.childNodes[0].attr('x', pos.x+10).attr('y', pos.y+10);
                nu.childNodes[1].attr('x', pos.x-10).attr('y', pos.y-10);
        });
        
        /* Arrows setup */
            var createMarker = function(id) {
                    return Viva.Graph.svg('marker')
                               .attr('id', id)
                               .attr('viewBox', "0 0 10 10")
                               .attr('refX', "10")
                               .attr('refY', "5")
                               .attr('markerUnits', "strokeWidth")
                               .attr('markerWidth', "10")
                               .attr('markerHeight', "2")
                               .attr('orient', "auto");
                },
            
            marker = createMarker('Triangle');
            marker.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');
            
            // Marker should be defined only once in <defs> child element of root <svg> element:
            var defs = graphics.getSvgRoot().append('defs');
            defs.append(marker);
            
            var geom = Viva.Graph.geom(); 
            
            graphics.link(function(link){
                // Notice the Triangle marker-end attribe:
                return Viva.Graph.svg('path')
                           .attr('stroke', link.data.color)
                           .attr('marker-end', 'url(#Triangle)');
            }).placeLink(function(linkUI, fromPos, toPos) {
                // Here we should take care about 
                //  "Links should start/stop at node's bounding box, not at the node center."
                
                // For rectangular nodes Viva.Graph.geom() provides efficient way to find
                // an intersection point between segment and rectangle
                var toNodeSize = nodeSize,
                    fromNodeSize = nodeSize;
                    
                var from = geom.intersectRect(
                        // rectangle:
                                fromPos.x - fromNodeSize / 2, // left
                                fromPos.y - fromNodeSize / 2, // top
                                fromPos.x + fromNodeSize / 2, // right
                                fromPos.y + fromNodeSize / 2, // bottom
                        // segment:
                                fromPos.x, fromPos.y, toPos.x, toPos.y) 
                           || fromPos; // if no intersection found - return center of the node
                
                var to = geom.intersectRect(
                        // rectangle:
                                toPos.x - toNodeSize / 2, // left
                                toPos.y - toNodeSize / 2, // top
                                toPos.x + toNodeSize / 2, // right
                                toPos.y + toNodeSize / 2, // bottom
                        // segment:
                                toPos.x, toPos.y, fromPos.x, fromPos.y) 
                            || toPos; // if no intersection found - return center of the node
                            
                var data = 'M' + from.x + ',' + from.y +
                           'L' + to.x + ',' + to.y;
                
                linkUI.attr("d", data);
            });

        for (var i=0; i<data.nodes.length; i++)
        {
                graph.addNode(data.nodes[i][0], {'name':data.nodes[i][1],'icon': data.nodes[i][2]});
        }
        for (var i=0; i<data.relations.length; i++)
        {
            graph.addLink(data.relations[i].parent, data.relations[i].child, {'color' : type_to_color(data.relations[i].type), 'type' : data.relations[i].type});
        }


    }
</script>

<script type="text/javascript" charset="utf-8">
        var MAX_RELATIONS_COUNT = 100;
        var fugue_data = "";

    $(document).ready(function()
    {
        /* 
          Don't make additional ajax call, just use graph_data directly. 
         */
        var graph_data = JSON.parse("{{graph_data|escapejs}}");
        if (graph_data.nodes.length > MAX_RELATIONS_COUNT)
        {
            alert('To many relations to draw a graph.')
        }
        else
        {
                fugue_data = "";
                jQuery.ajax({
                url: '/static/cmdb/fugue-icons.json',
                success: function(html) {
                        fugue_data = html;
                },
                async:false
                });
                //fugue_data = JSON.parse(fugue_data);

            var can = document.createElement('canvas')
            can.style.display = 'none';
            var ctx = can.getContext('2d');
            var img = new Image();
            img.onload = function(){
                can.width = img.width;
                can.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                draw_graph(graph_data, can);
            }
            var sprite_url = '/static/fugue-icons.png';
            img.src = sprite_url; 
        }
    });
</script>

{% endblock %}

{% block contentarea %}
    {{ block.super }}

    {% form_horizontal form=form method="get" action="/cmdb/graphs" title='Formularz' %}
    <hr>
    <table class="table table-striped table-condensed table-list table-bordered">
        <tbody>
        <tr>
            <th>L.p</th>
            <th>Name</th>
            <th>Type</th>
            <th>UID</th>
            <th>Venture/Role</th>
        </tr>
        {% for row in rows %}
        <tr>
            <td>
                {{ forloop.counter }}
            </td>
            <td>
            <a href="/cmdb/ci/view/{{ row.ci.id }}">
                <b><i class='fugue-icon {{ row.icon }}'></i> {{ row.ci.name }} </b> 
            </a></td>
            <td>{{ row.ci.type }} {{ row.ci.content_object.model}}</td>
            <td>{{ row.ci.uid }}</td>
            <td>{{ row.content_object.venture}} {{ row.content_object.role }}</td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
    <h4> Impact graph </h4>
    <div id='graphDiv' width=800 height=800 style='width:800px; height:800px;border: solid #ddd 1px'>
    </div>

{% endblock %}
